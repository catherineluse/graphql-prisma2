# Migration `20200628163229`

This migration has been generated by catherineluse at 6/28/2020, 4:32:30 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."SubscribersOfCommunities" (
"communityUrl" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userHandle" text  NOT NULL ,
    PRIMARY KEY ("communityUrl","userHandle"))

CREATE TABLE "public"."CreatorsOfCommunities" (
"communityUrl" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userHandle" text  NOT NULL ,
    PRIMARY KEY ("communityUrl","userHandle"))

CREATE TABLE "public"."AuthorsOfMessages" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"messageId" integer  NOT NULL ,"userHandle" text  NOT NULL ,
    PRIMARY KEY ("messageId","userHandle"))

CREATE TABLE "public"."RecipientsOfMessages" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"messageId" integer  NOT NULL ,"userHandle" text  NOT NULL ,
    PRIMARY KEY ("messageId","userHandle"))

CREATE TABLE "public"."_SubscribersOfCommunities" (
"A" integer  NOT NULL ,"B" integer  NOT NULL )

ALTER TABLE "public"."Comment" DROP COLUMN "authorId",
ADD COLUMN "authorHandle" text  NOT NULL ;

ALTER TABLE "public"."Community" DROP COLUMN "creatorId",
ADD COLUMN "creatorHandle" text  NOT NULL ;

ALTER TABLE "public"."Discussion" DROP COLUMN "authorId",
DROP COLUMN "communityId",
ADD COLUMN "authorHandle" text  NOT NULL ,
ADD COLUMN "communityUrl" text  NOT NULL ;

ALTER TABLE "public"."Message" DROP COLUMN "authorId",
DROP COLUMN "recipientId",
ADD COLUMN "authorHandle" text  NOT NULL ,
ADD COLUMN "recipientHandle" text  NOT NULL ;

ALTER TABLE "public"."User" ADD COLUMN "id" SERIAL,
ALTER COLUMN "handle" SET NOT NULL;

CREATE UNIQUE INDEX "_SubscribersOfCommunities_AB_unique" ON "public"."_SubscribersOfCommunities"("A","B")

CREATE  INDEX "_SubscribersOfCommunities_B_index" ON "public"."_SubscribersOfCommunities"("B")

CREATE UNIQUE INDEX "User.handle" ON "public"."User"("handle")

ALTER TABLE "public"."SubscribersOfCommunities" ADD FOREIGN KEY ("communityUrl")REFERENCES "public"."Community"("url") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."SubscribersOfCommunities" ADD FOREIGN KEY ("userHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."CreatorsOfCommunities" ADD FOREIGN KEY ("communityUrl")REFERENCES "public"."Community"("url") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."CreatorsOfCommunities" ADD FOREIGN KEY ("userHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."AuthorsOfMessages" ADD FOREIGN KEY ("messageId")REFERENCES "public"."Message"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."AuthorsOfMessages" ADD FOREIGN KEY ("userHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."RecipientsOfMessages" ADD FOREIGN KEY ("messageId")REFERENCES "public"."Message"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."RecipientsOfMessages" ADD FOREIGN KEY ("userHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_SubscribersOfCommunities" ADD FOREIGN KEY ("A")REFERENCES "public"."Community"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_SubscribersOfCommunities" ADD FOREIGN KEY ("B")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Comment" ADD FOREIGN KEY ("authorHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Community" ADD FOREIGN KEY ("creatorHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Discussion" ADD FOREIGN KEY ("authorHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Discussion" ADD FOREIGN KEY ("communityUrl")REFERENCES "public"."Community"("url") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Message" ADD FOREIGN KEY ("authorHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Message" ADD FOREIGN KEY ("recipientHandle")REFERENCES "public"."User"("handle") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER INDEX "public"."User_email_key" RENAME TO "User.email"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200628151933..20200628163229
--- datamodel.dml
+++ datamodel.dml
@@ -3,66 +3,66 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model Comment {
-  authorId      Int
+  authorHandle  String
   createdAt     DateTime   @default(now())
   discussionId  Int
   id            Int        @id
   text          String
-  User          User       @relation(fields: [authorId], references: [id])
+  User          User       @relation(fields: [authorHandle], references: [handle])
   Discussion    Discussion @relation(fields: [discussionId], references: [id])
   parentComment Comment    @relation("CommentToComment_id", fields: [id], references: [id])
   childComment  Comment[]  @relation("CommentToComment_id")
 }
 model Community {
   createdAt                DateTime                   @default(now())
-  creatorId                Int
+  creatorHandle            String
   description              String?
   id                       Int                        @default(autoincrement()) @id
   name                     String
   url                      String                     @unique
-  Creator                  User                       @relation("CreatorsOfCommunities", fields: [creatorId], references: [id])
+  Creator                  User                       @relation("CreatorsOfCommunities", fields: [creatorHandle], references: [handle])
   Subscribers              User[]                     @relation("SubscribersOfCommunities", references: [id])
   Discussion               Discussion[]
   SubscribersOfCommunities SubscribersOfCommunities[]
   CreatorsOfCommunities    CreatorsOfCommunities[]
 }
 model Discussion {
-  authorId    Int
-  body        String?
-  communityId Int
-  createdAt   DateTime  @default(now())
-  id          Int       @default(autoincrement()) @id
-  title       String
-  User        User      @relation(fields: [authorId], references: [id])
-  Community   Community @relation(fields: [communityId], references: [id])
-  Comment     Comment[]
+  authorHandle String
+  body         String?
+  communityUrl String
+  createdAt    DateTime  @default(now())
+  id           Int       @default(autoincrement()) @id
+  title        String
+  User         User      @relation(fields: [authorHandle], references: [handle])
+  Community    Community @relation(fields: [communityUrl], references: [url])
+  Comment      Comment[]
 }
 model Message {
-  authorId             Int
+  authorHandle         String
   createdAt            DateTime               @default(now())
   id                   Int                    @default(autoincrement()) @id
-  recipientId          Int
+  recipientHandle      String
   text                 String
-  Author               User                   @relation("AuthorsOfMessages", fields: [authorId], references: [id])
-  Recipient            User                   @relation("RecipientsOfMessages", fields: [recipientId], references: [id])
+  Author               User                   @relation("AuthorsOfMessages", fields: [authorHandle], references: [handle])
+  Recipient            User                   @relation("RecipientsOfMessages", fields: [recipientHandle], references: [handle])
   AuthorsOfMessages    AuthorsOfMessages[]
   RecipientsOfMessages RecipientsOfMessages[]
 }
 model User {
+  id                       Int                        @default(autoincrement()) @id
   age                      Int?
   createdAt                DateTime                   @default(now())
   email                    String                     @unique
-  id                       Int                        @default(autoincrement()) @id
   name                     String
   handle                   String                     @unique
   Comment                  Comment[]
   CreatorOfCommunities     Community[]                @relation("CreatorsOfCommunities")
@@ -81,38 +81,38 @@
   USER
 }
 model SubscribersOfCommunities {
-  Community   Community @relation(fields: [communityId], references: [id])
-  communityId Int
-  User        User      @relation(fields: [userId], references: [id])
-  userId      Int
-  createdAt   DateTime  @default(now())
-  @@id([communityId, userId])
+  Community    Community @relation(fields: [communityUrl], references: [url])
+  communityUrl String
+  User         User      @relation(fields: [userHandle], references: [handle])
+  userHandle   String
+  createdAt    DateTime  @default(now())
+  @@id([communityUrl, userHandle])
 }
 model CreatorsOfCommunities {
-  Community   Community @relation(fields: [communityId], references: [id])
-  communityId Int
-  User        User      @relation(fields: [userId], references: [id])
-  userId      Int
-  createdAt   DateTime  @default(now())
-  @@id([communityId, userId])
+  Community    Community @relation(fields: [communityUrl], references: [url])
+  communityUrl String
+  User         User      @relation(fields: [userHandle], references: [handle])
+  userHandle   String
+  createdAt    DateTime  @default(now())
+  @@id([communityUrl, userHandle])
 }
 model AuthorsOfMessages {
-  Message   Message  @relation(fields: [messageId], references: [id])
-  messageId Int
-  User      User     @relation(fields: [userId], references: [id])
-  userId    Int
-  createdAt DateTime @default(now())
-  @@id([messageId, userId])
+  Message    Message  @relation(fields: [messageId], references: [id])
+  messageId  Int
+  User       User     @relation(fields: [userHandle], references: [handle])
+  userHandle String
+  createdAt  DateTime @default(now())
+  @@id([messageId, userHandle])
 }
 model RecipientsOfMessages {
-  Message   Message  @relation(fields: [messageId], references: [id])
-  messageId Int
-  User      User     @relation(fields: [userId], references: [id])
-  userId    Int
-  createdAt DateTime @default(now())
-  @@id([messageId, userId])
+  Message    Message  @relation(fields: [messageId], references: [id])
+  messageId  Int
+  User       User     @relation(fields: [userHandle], references: [handle])
+  userHandle String
+  createdAt  DateTime @default(now())
+  @@id([messageId, userHandle])
 }
```


